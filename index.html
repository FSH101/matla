<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Matreshka API (Browser Demo)</title>
  <style>
    :root { color-scheme: dark; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 16px; background:#0b0f14; color:#e6edf3; }
    .grid { display:grid; grid-template-columns: 1fr; gap: 14px; max-width: 1100px; margin: 0 auto; }
    .card { background:#111826; border:1px solid #223044; border-radius: 12px; padding: 12px; }
    h1 { font-size: 18px; margin: 0 0 8px; }
    h2 { font-size: 14px; margin: 0 0 10px; color:#c6d6ff; }
    label { display:block; font-size: 12px; opacity:.9; margin: 8px 0 4px; }
    input, select, textarea, button { width: 100%; box-sizing: border-box; padding: 10px; border-radius: 10px; border: 1px solid #2b3a52; background:#0b1220; color:#e6edf3; }
    textarea { min-height: 90px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    .row { display:flex; gap: 10px; flex-wrap: wrap; }
    .row > * { flex: 1; min-width: 180px; }
    button { cursor:pointer; background:#16233a; }
    button:hover { background:#1b2b47; }
    .small { font-size: 12px; opacity: .85; line-height: 1.35; }
    pre { white-space: pre-wrap; word-break: break-word; background:#0a1220; border:1px solid #223044; border-radius: 12px; padding: 10px; margin: 8px 0 0; }
    .ok { color:#9cffc6; }
    .bad { color:#ffb4b4; }
    .pill { display:inline-block; padding:2px 8px; border-radius:999px; border:1px solid #2b3a52; font-size:12px; opacity:.95; }
  </style>
</head>
<body>
  <div class="grid">
    <div class="card">
      <h1>Matreshka API (Browser Demo)</h1>
      <div class="small">
        Этот демо-сайт дергает публичные URL через Cloudflare Worker‑прокси (иначе CORS блокирует запросы).
        Для авторизованных запросов вручную держишь <span class="pill">accountId</span> и <span class="pill">sessionHash</span>.
      </div>
    </div>

    <div class="card">
      <h2>Сессия</h2>

      <label>proxyBase (Cloudflare Worker)</label>
      <input id="proxyBase" type="text" placeholder="https://xxxx.workers.dev/?url=" />

      <div class="row">
        <div>
          <label>deviceHash</label>
          <input id="deviceHash" type="text" />
        </div>
        <div>
          <label>client</label>
          <select id="client">
            <option value="prod" selected>prod</option>
            <option value="google">google</option>
            <option value="appgallery">appgallery</option>
            <option value="rustore">rustore</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div>
          <label>accountId</label>
          <input id="accountId" type="number" />
        </div>
        <div>
          <label>sessionHash</label>
          <input id="sessionHash" type="text" />
        </div>
      </div>

      <div class="row">
        <button id="btnSave">Save (localStorage)</button>
        <button id="btnLoad">Load</button>
        <button id="btnNewDevice">New deviceHash</button>
      </div>

      <div class="small">
        После обновления GitHub Pages делай <b>Ctrl+F5</b> или открывай в инкогнито — иначе кеш.
      </div>
    </div>

    <div class="card">
      <h2>Публичные конфиги (без авторизации)</h2>
      <div class="row">
        <button id="btnUpdate">GET update.php</button>
        <button id="btnMain">GET api/main.json</button>
        <button id="btnServersJson">GET servers.json</button>
      </div>

      <label>files_list URL (берётся из update.php или вставь вручную)</label>
      <div class="row">
        <input id="filesListUrl" type="text" placeholder="https://moblauncher.matrp.ru/files_list/build1411.json" />
        <button id="btnFilesList">GET files_list</button>
      </div>
    </div>

    <div class="card">
      <h2>Email auth</h2>
      <div class="small">
        Важно: оригинальный API обычно ждёт <b>GET</b>.
        Чтобы пароль не светился в URL страницы, мы отправляем его в <b>POST на Worker</b>, а Worker превращает это в <b>GET к апстриму</b>.
      </div>

      <div class="row">
        <div>
          <label>email</label>
          <input id="email" type="text" placeholder="name@example.com" />
        </div>
        <div>
          <label>password</label>
          <input id="pass" type="password" />
        </div>
      </div>

      <div class="row">
        <button id="btnLogin">Login (type=email, subtype=auth)</button>
        <button id="btnRegStart">Register (type=email, subtype=register)</button>
      </div>

      <div class="row">
        <div>
          <label>verification code</label>
          <input id="code" type="text" />
        </div>
        <button id="btnRegFinish">Register code (subtype=register_code)</button>
      </div>

      <label style="display:flex; gap:8px; align-items:center; margin:10px 0 0;">
        <input id="authIncludeSession" type="checkbox" />
        <span class="small">Добавлять accountId/sessionHash в Auth (обычно не нужно)</span>
      </label>
    </div>

    <div class="card">
      <h2>Авторизованные запросы</h2>
      <div class="row">
        <button id="btnServersApi">GET /api/Requests/Servers.php</button>
        <button id="btnAccount">GET /api/Requests/AccountDetails.php</button>
        <button id="btnCabinet">GET /api/Requests/Cabinet.php</button>
      </div>

      <div class="row">
        <div>
          <label>Server host</label>
          <input id="srvHost" type="text" placeholder="91.220.80.xx" />
        </div>
        <div>
          <label>Server port</label>
          <input id="srvPort" type="number" placeholder="7777" />
        </div>
      </div>

      <div class="row">
        <button id="btnSelectServer">SelectServer.php</button>
        <button id="btnPlay">Play.php</button>
      </div>
    </div>

    <div class="card">
      <h2>Custom request</h2>
      <div class="row">
        <div>
          <label>URL</label>
          <input id="customUrl" type="text" placeholder="https://moblauncher.matrp.ru/servers.json" />
        </div>
        <div>
          <label>Method</label>
          <select id="customMethod">
            <option value="GET" selected>GET</option>
            <option value="POST">POST</option>
          </select>
        </div>
      </div>

      <label>POST form (key=value&...)</label>
      <textarea id="customBody" placeholder="type=email&subtype=auth&action=continue&email=...&pass=..."></textarea>

      <label style="display:flex; gap:8px; align-items:center; margin:10px 0 0;">
        <input id="customUpstreamPost" type="checkbox" />
        <span class="small">Для POST: реально отправлять POST апстриму (иначе Worker преобразует в GET)</span>
      </label>

      <div class="row">
        <button id="btnCustom">Send</button>
        <button id="btnDebugUpstream">Worker debug=1</button>
      </div>

      <div class="small">
        Debug вернёт status/content-type/location/первые байты ответа апстрима (удобно, когда вместо JSON прилетает HTML или пусто).
      </div>
    </div>

    <div class="card">
      <h2>Output</h2>
      <pre id="out">(ready)</pre>
    </div>
  </div>

<script>
(function () {
  function qs(id) { return document.getElementById(id); }

  function randDeviceHash() {
    var chars = "abcdefghijklmnopqrstuvwxyz0123456789";
    var s = "";
    for (var i = 0; i < 16; i++) s += chars.charAt(Math.floor(Math.random() * chars.length));
    return s;
  }

  function parseForm(text) {
    var obj = {};
    if (!text) return obj;
    var t = String(text).trim();
    if (!t) return obj;

    var parts = t.indexOf("&") !== -1 ? t.split("&") : t.split(/\n+/);
    for (var i = 0; i < parts.length; i++) {
      var p = String(parts[i] || "").trim();
      if (!p) continue;
      var eq = p.indexOf("=");
      if (eq === -1) continue;
      var k = decodeURIComponent(p.slice(0, eq).trim());
      var v = decodeURIComponent(p.slice(eq + 1).trim());
      obj[k] = v;
    }
    return obj;
  }

  function buildFormBody(obj) {
    var parts = [];
    for (var k in obj) {
      if (!Object.prototype.hasOwnProperty.call(obj, k)) continue;
      var v = obj[k];
      if (v === undefined || v === null) v = "";
      parts.push(encodeURIComponent(k) + "=" + encodeURIComponent(String(v)));
    }
    return parts.join("&");
  }

  function setOut(o, ok) {
    var el = qs("out");
    try {
      el.textContent = (typeof o === "string") ? o : JSON.stringify(o, null, 2);
    } catch (e) {
      el.textContent = String(o);
    }
    el.className = ok ? "ok" : "bad";
  }

  var state = {
    api: "https://moblauncher.matrp.ru",
    proxyBase: "",
    deviceHash: "",
    client: "prod",
    accountId: -1,
    sessionHash: ""
  };

  function loadState() {
    try {
      var s = localStorage.getItem("mat_demo_state_v14");
      if (s) {
        var o = JSON.parse(s);
        if (o && typeof o === "object") {
          for (var k in o) state[k] = o[k];
        }
      }
    } catch (e) {}
  }

  function saveState() {
    try { localStorage.setItem("mat_demo_state_v14", JSON.stringify(state)); } catch (e) {}
  }

  function renderState() {
    qs("proxyBase").value = state.proxyBase || "";
    qs("deviceHash").value = state.deviceHash || "";
    qs("client").value = state.client || "prod";
    qs("accountId").value = String(state.accountId);
    qs("sessionHash").value = state.sessionHash || "";
  }

  function pullStateFromUI() {
    state.proxyBase = String(qs("proxyBase").value || "").trim();
    state.deviceHash = String(qs("deviceHash").value || "").trim();
    if (!state.deviceHash) {
      state.deviceHash = randDeviceHash();
      qs("deviceHash").value = state.deviceHash;
    }
    state.client = String(qs("client").value || "prod").trim() || "prod";
    state.accountId = parseInt(qs("accountId").value, 10);
    if (isNaN(state.accountId)) state.accountId = -1;
    state.sessionHash = String(qs("sessionHash").value || "").trim();
  }

  async function decodeTextSmart(resp) {
    var buf = await resp.arrayBuffer();

    var textUtf8 = "";
    try { textUtf8 = new TextDecoder("utf-8").decode(buf); } catch (e) { textUtf8 = ""; }

    var text1251 = "";
    try { text1251 = new TextDecoder("windows-1251").decode(buf); } catch (e) { text1251 = ""; }

    var hasBad = (textUtf8.indexOf("\uFFFD") !== -1) || (textUtf8.indexOf("����") !== -1);
    if (hasBad && text1251 && text1251.indexOf("\uFFFD") === -1) return text1251;

    return textUtf8 || text1251 || "";
  }

  async function fetchViaProxy(method, url, formObj, workerParams) {
    pullStateFromUI();
    if (!state.proxyBase) {
      return { ok: false, status: 0, error: "proxyBase пустой. Вставь URL воркера: https://xxxx.workers.dev/?url=" };
    }

    var extra = workerParams ? String(workerParams) : "";
    var glue = state.proxyBase.indexOf("?") === -1 ? "?" : "";
    // proxyBase должен заканчиваться на ?url= (или &url=) — мы это не навязываем, но подстрахуемся:
    var proxyBase = state.proxyBase;
    if (proxyBase.indexOf("url=") === -1) {
      // попробуем аккуратно добавить url=
      proxyBase = proxyBase.replace(/\?$/, "");
      if (proxyBase.indexOf("?") === -1) proxyBase += "?url=";
      else proxyBase += "&url=";
    }
    var proxyUrl = proxyBase + encodeURIComponent(url) + extra;

    var opts = { method: method };
    if (method === "POST") {
      opts.headers = { "content-type": "application/x-www-form-urlencoded; charset=utf-8" };
      opts.body = buildFormBody(formObj || {});
    }

    var resp;
    try {
      resp = await fetch(proxyUrl, opts);
    } catch (e) {
      return { ok: false, status: 0, error: String(e) };
    }

    var contentType = resp.headers.get("content-type") || "";
    var rawText = await decodeTextSmart(resp);

    // JSON parse try
    var parsed;
    try { parsed = JSON.parse(rawText); }
    catch (e) {
      return { ok: resp.ok, status: resp.status, contentType: contentType, raw: rawText };
    }

    // Важно: JSON "null" — валидный JSON, но пользователю непонятно. Упакуем.
    if (parsed === null) {
      return { ok: resp.ok, status: resp.status, contentType: contentType, parsed: null, raw: rawText };
    }
    return parsed;
  }

  function withBaseParams(obj, includeSession) {
    var o = {};
    for (var k in obj) o[k] = obj[k];

    o.deviceHash = state.deviceHash;
    o.client = state.client;

    if (includeSession) {
      o.accountId = state.accountId;
      o.sessionHash = state.sessionHash || "";
    }
    return o;
  }

  async function getUpdate() {
    var url = state.api + "/update.php?accountId=-1&deviceHash=" + encodeURIComponent(state.deviceHash) + "&client=" + encodeURIComponent(state.client);
    var res = await fetchViaProxy("GET", url);
    if (res && res.files_list) qs("filesListUrl").value = res.files_list;
    setOut(res, true);
  }

  async function getMain() {
    var url = state.api + "/api/main.json";
    var res = await fetchViaProxy("GET", url);
    setOut(res, true);
  }

  async function getServersJson() {
    var url = state.api + "/servers.json";
    var res = await fetchViaProxy("GET", url);
    setOut(res, true);
  }

  async function getFilesList() {
    var url = String(qs("filesListUrl").value || "").trim();
    if (!url) { setOut({ ok:false, error: "files_list URL пустой" }, false); return; }
    var res = await fetchViaProxy("GET", url);
    setOut(res, true);
  }

  async function authEmail(subtype, extra) {
    var includeSession = qs("authIncludeSession").checked ? true : false;

    var url = state.api + "/api/Requests/Auth.php";

    var data = withBaseParams({
      type: "email",
      subtype: subtype,
      action: "continue"
    }, includeSession);

    for (var k in (extra || {})) data[k] = extra[k];

    // Мы делаем POST на Worker, Worker превращает это в GET апстриму (по умолчанию).
    var res = await fetchViaProxy("POST", url, data);

    // Попробуем вытащить accountId/sessionHash из типовых структур
    var a0 = null;
    if (res && res.actions && res.actions[0]) a0 = res.actions[0];
    if (!a0 && res && res.action) a0 = res.action;

    if (a0 && a0.account_id !== undefined && a0.account_id !== null) {
      state.accountId = a0.account_id;
      state.sessionHash = a0.session_hash || "";
      saveState();
      renderState();
    }

    setOut(res, true);
  }

  async function authedGet(path) {
    pullStateFromUI();
    if (!state.sessionHash) { setOut({ ok:false, error: "sessionHash пустой. Нужна авторизация." }, false); return; }

    var base = state.api + path;
    var q = buildFormBody(withBaseParams({}, true));
    var url = base + "?" + q;

    var res = await fetchViaProxy("GET", url);
    setOut(res, true);
  }

  async function selectServer() {
    pullStateFromUI();
    if (!state.sessionHash) { setOut({ ok:false, error: "Необходимо авторизоваться (sessionHash пустой)" }, false); return; }

    var host = String(qs("srvHost").value || "").trim();
    var port = String(qs("srvPort").value || "").trim();
    if (!host || !port) { setOut({ ok:false, error: "host/port пустые" }, false); return; }

    var url = state.api + "/api/Requests/SelectServer.php";
    var data = withBaseParams({ host: host, port: port }, true);

    var res = await fetchViaProxy("GET", url + "?" + buildFormBody(data));
    setOut(res, true);
  }

  async function play() {
    pullStateFromUI();
    var host = String(qs("srvHost").value || "").trim();
    var port = String(qs("srvPort").value || "").trim();

    var url = state.api + "/api/Requests/Play.php";
    var data = withBaseParams({ host: host, port: port }, true);

    var res = await fetchViaProxy("GET", url + "?" + buildFormBody(data));
    setOut(res, true);
  }

  async function customSend() {
    pullStateFromUI();
    var url = String(qs("customUrl").value || "").trim();
    if (!url) { setOut({ ok:false, error: "URL пустой" }, false); return; }

    var method = String(qs("customMethod").value || "GET");
    var bodyObj = parseForm(qs("customBody").value || "");
    var upstreamPost = qs("customUpstreamPost").checked;

    var extra = upstreamPost ? "&upstream=post" : "";
    var res;
    if (method === "POST") res = await fetchViaProxy("POST", url, bodyObj, extra);
    else res = await fetchViaProxy("GET", url);
    setOut(res, true);
  }

  async function workerDebug() {
    pullStateFromUI();
    var url = String(qs("customUrl").value || "").trim();
    if (!url) { setOut({ ok:false, error: "URL пустой" }, false); return; }

    // debug=1 — это параметр воркера, не апстрима
    var dbgBase = state.proxyBase;
    if (dbgBase.indexOf("url=") === -1) {
      dbgBase = dbgBase.replace(/\?$/, "");
      if (dbgBase.indexOf("?") === -1) dbgBase += "?url=";
      else dbgBase += "&url=";
    }
    var dbg = dbgBase.replace(/url=$/, "debug=1&url=");
    var full = dbg + encodeURIComponent(url);

    try {
      var r = await fetch(full);
      var j = await r.json();
      setOut(j, true);
    } catch (e) {
      setOut({ ok:false, error: String(e), hint: "Проверь, что в worker.js есть debug=1" }, false);
    }
  }

  // ---- wire ----
  loadState();
  if (!state.deviceHash) state.deviceHash = randDeviceHash();
  renderState();

  qs("btnSave").onclick = function () { pullStateFromUI(); saveState(); setOut({ ok:true, saved: state }, true); };
  qs("btnLoad").onclick = function () { loadState(); renderState(); setOut({ ok:true, loaded: state }, true); };
  qs("btnNewDevice").onclick = function () { state.deviceHash = randDeviceHash(); saveState(); renderState(); setOut({ ok:true, deviceHash: state.deviceHash }, true); };

  qs("btnUpdate").onclick = function () { getUpdate(); };
  qs("btnMain").onclick = function () { getMain(); };
  qs("btnServersJson").onclick = function () { getServersJson(); };
  qs("btnFilesList").onclick = function () { getFilesList(); };

  qs("btnLogin").onclick = function () {
    var email = String(qs("email").value || "").trim();
    var pass = String(qs("pass").value || "");
    authEmail("auth", { email: email, pass: pass });
  };

  qs("btnRegStart").onclick = function () {
    var email = String(qs("email").value || "").trim();
    var pass = String(qs("pass").value || "");
    authEmail("register", { email: email, pass: pass, repeat_pass: pass });
  };

  qs("btnRegFinish").onclick = function () {
    var email = String(qs("email").value || "").trim();
    var pass = String(qs("pass").value || "");
    var code = String(qs("code").value || "").trim();
    authEmail("register_code", { email: email, pass: pass, repeat_pass: pass, code: code });
  };

  qs("btnServersApi").onclick = function () { authedGet("/api/Requests/Servers.php"); };
  qs("btnAccount").onclick = function () { authedGet("/api/Requests/AccountDetails.php"); };
  qs("btnCabinet").onclick = function () { authedGet("/api/Requests/Cabinet.php"); };

  qs("btnSelectServer").onclick = function () { selectServer(); };
  qs("btnPlay").onclick = function () { play(); };

  qs("btnCustom").onclick = function () { customSend(); };
  qs("btnDebugUpstream").onclick = function () { workerDebug(); };

  setOut("(ready)", true);
})();
</script>
</body>
</html>
